{% extends "lotto/base.html" %}
{% load lotto_extras %}

{% block title %}{{ round.round_number }}회 당첨자 / 통계 | 로또 사이트{% endblock %}

{% block content %}
<h2 class="page-title">{{ round.round_number }}회 당첨자 / 통계</h2>
<p class="page-subtitle">
    추첨일: {{ round.draw_date }}
</p>

<div class="row g-3 mb-4">
    <!-- 당첨 번호 카드 -->
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header fw-bold">
                당첨 번호
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <span class="me-2 fw-semibold">메인 번호:</span>
                    {% for n in round.winning_numbers|split_numbers %}
                        <span class="lotto-ball {{ n|lotto_color }}">{{ n }}</span>
                    {% endfor %}
                </div>
                <div class="mt-2">
                    <span class="me-2 fw-semibold">보너스 번호:</span>
                    {% if round.bonus_number %}
                        <span class="lotto-ball bonus">{{ round.bonus_number }}</span>
                    {% else %}
                        -
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 간단 통계 카드 -->
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header fw-bold">
                당첨 통계 요약
            </div>
            <div class="card-body">
                <p class="mb-2">
                    총 발행 티켓 수: <strong>{{ total_tickets }}</strong> 장
                </p>
                <ul class="list-group list-group-flush small">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        1등
                        <span class="badge bg-danger rounded-pill">{{ stats.1|default:0 }}명</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        2등
                        <span class="badge bg-warning text-dark rounded-pill">{{ stats.2|default:0 }}명</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        3등
                        <span class="badge bg-primary rounded-pill">{{ stats.3|default:0 }}명</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        4등
                        <span class="badge bg-success rounded-pill">{{ stats.4|default:0 }}명</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        5등
                        <span class="badge bg-secondary rounded-pill">{{ stats.5|default:0 }}명</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<h3 class="mt-4">당첨 티켓 목록</h3>

{% if winners %}
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col">사용자</th>
                        <th scope="col">선택 번호</th>
                        <th scope="col">등수</th>
                        <th scope="col" class="text-end">당첨 금액</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in winners %}
                        <tr>
                            <td>{{ t.user.username }}</td>
                            <td>
                                {% for n in t.numbers|split_numbers %}
                                    {% with winning_list=round.winning_numbers|split_numbers %}
                                        {% if n in winning_list %}
                                            <span class="lotto-ball {{ n|lotto_color }}" style="border: 2px solid #000; box-shadow: 0 0 4px rgba(0,0,0,0.5);">{{ n }}</span>
                                        {% elif n == round.bonus_number %}
                                            <span class="lotto-ball bonus" style="border: 2px solid #000; box-shadow: 0 0 4px rgba(0,0,0,0.5);">{{ n }}</span>
                                        {% else %}
                                            <span class="lotto-ball {{ n|lotto_color }}">{{ n }}</span>
                                        {% endif %}
                                    {% endwith %}
                                {% endfor %}
                            </td>
                            <td>
                                <span class="badge {{ t.rank|rank_badge_class }}">
                                    {{ t.rank|rank_label }}
                                </span>
                            </td>
                            <td class="text-end">
                                {{ t.prize|prize_display }}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% else %}
    <div class="alert alert-info mt-3">
        아직 당첨 티켓이 없습니다.
    </div>
{% endif %}

<div class="mt-3">
    <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary btn-sm">
        ← 관리자 대시보드로 돌아가기
    </a>
</div>
{% endblock %}
